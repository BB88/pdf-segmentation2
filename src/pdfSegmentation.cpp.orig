//============================================================================
// Name        : prova.cpp
// Author      : 
// Version     :
// Copyright   : Your copyright notice
// Description : Hello World in C++, Ansi-style
//============================================================================


#include <algorithm>
#include <cstdio>
#include <sstream>

#include <iostream>
#include "tinyxml.h"
#include <stdio.h>
#include <string.h>
#include <vector>
#include <math.h>

#include "bitmap_image.hpp"



using namespace std;



double* get_coord(TiXmlElement* itemElement);
double* get_coord(TiXmlElement* itemElement){

	const char *co = itemElement->Attribute("bbox");
	char * test;
	double coord[4];
	int l=0;
	test = strtok ((char*)co,",");
	while (test != NULL)
		{
			coord[l] = atof(test);
			test = strtok (NULL, ",");
			++l;
		}
	return coord;
}



bool scan_page (  TiXmlNode* node, bitmap_image image, int i, int y );

bool scan_page (  TiXmlNode* node, bitmap_image image, int i,int y  ){


	std::stringstream name_out_ss;
<<<<<<< HEAD
	name_out_ss << "/home/bene/Scrivania/prova-"<<i<<"_draw2.bmp";
=======
	name_out_ss <<  "/home/miky/Scrivania/progettoTBD/andre_bbox-"<<i<<".bmp";
>>>>>>> f4e0e44e7d50b4bd5702feb38a20ff20fd7e4756
	TiXmlElement* itemElement = 0;
	TiXmlElement* lineElement=0;
	TiXmlElement* nextline=0;

	int k=0;
	bool f2=true;


	image_drawer draw(image);
	while (f2){

		if (k==0){	itemElement = node-> FirstChildElement("textbox"); }
		else {itemElement = itemElement->NextSiblingElement("textbox");}

		if (itemElement==0) {f2=false;}
		else {

				lineElement = itemElement->FirstChildElement("textline");
				bool f3=true;

				double *coord=get_coord(itemElement);
				int a=int(coord[0])+25;
				int b=y-int(coord[1]);
				int c =int(coord[2])+25;
				int	d=y-int(coord[3]);

				draw.rectangle(a,b,c,d);
// togliere questo while per tagliare solo i bbox
//					 while (f3){
//
//						nextline=lineElement->NextSiblingElement("textline");
//						if (nextline == 0 ) {f3=false;}
//						else {
//							int l1=atof(lineElement->FirstChildElement("text")->Attribute("size"));
//							int l2=atof(nextline->FirstChildElement("text")->Attribute("size"));
//							std::string font1 = lineElement->FirstChildElement("text")->Attribute("font");
//							std::string font2 = nextline->FirstChildElement("text")->Attribute("font");
//							//se devo tagliare
//							if(l1!=l2 || font1!=font2){
//								double *co=get_coord(nextline);
//								d=y-int(co[3]);
//								draw.rectangle(a,b,c,d);
//								//b=int(co[1])+25;
//
//							}
//
//							lineElement=nextline;
//							if (nextline->NextSiblingElement("textline")==0){f3=false;}
//						}
//
//				  }
				++k;
		}

		if (itemElement->NextSibling("textbox")==0){f2=false;}
		}
	image.save_image(name_out_ss.str());
	return true;
}


int main() {



	cout << "!!!Hello World!!!" << endl; // prints !!!Hello World!!!
	TiXmlDocument doc;
<<<<<<< HEAD
	if(!doc.LoadFile("/home/bene/Scrivania/esempio.xml"))
=======

	if(!doc.LoadFile("/home/miky/Scrivania/progettoTBD/xml/andre.xml"))
>>>>>>> f4e0e44e7d50b4bd5702feb38a20ff20fd7e4756
	{
	    cerr << doc.ErrorDesc() << endl;
	    return 0;
	}

	TiXmlNode* node = 0;


	node = doc.FirstChildElement( "pages" );
	assert( node );

	TiXmlElement* Element = 0;
	Element = node-> FirstChildElement("page");
	double *y_coord=get_coord(Element);
	int y= y_coord[3];

int i=0;
bool f1=true;

while (f1){

		std::stringstream name_ss;
<<<<<<< HEAD
		name_ss << "/home/bene/Scrivania/prova-"<<i<<".bmp";
=======

		name_ss <<"/home/miky/Scrivania/progettoTBD/andre-"<<i<<".bmp";
>>>>>>> f4e0e44e7d50b4bd5702feb38a20ff20fd7e4756
		bitmap_image image(name_ss.str());

		if (i==0) {	node = node->FirstChildElement("page");}
		else {node = node->NextSiblingElement("page");}

		if (node==0 ) {f1=false;}

		else {

		scan_page (node,image,i,y);
		++i;
		}
		if  (node->NextSiblingElement("page")==0){f1=false;}
	}
	return 0;
}
